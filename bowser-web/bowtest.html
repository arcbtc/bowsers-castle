<html>
  <input type="text" id="myText" ></input>
  <button type="button" onclick="connectToPort()">Connect</button>
  <button type="button" onclick="writeData('cunt')">write</button>
  <button type="button" onclick="readPort()">read</button>
  <button id="cancelbow">Close</button>
  <h2 id="myTex"></h2>
</html>

<script>

let portCounter = 1;
let port;
let reader;

async function readPort(){
  await port.open({ baudRate: 115200 });
  while (port && port.readable) {
    try {
      reader = port.readable.getReader();
      for (;;) {
        const {value, done} = await reader.read();
        if (value) {
          console.log(ab2str(value));
          document.getElementById("myTex").innerHTML = await ab2str(value);
        }
        if (ab2str(value) == "OVER") {
          break;
        }
      }
      reader.releaseLock();
      reader = undefined;
    } catch (e) {
    }
  }
  if (port) {
    try {
      await port.close();
    } catch (e) {
    }
  }
}

async function connectToPort(){
  port = await navigator.serial.requestPort();
  console.log(port);
}

async function ab2str(buf) {
  return String.fromCharCode.apply(null, new Uint16Array(buf));
}

//////////////////////////////


async function writeData(data){
  const encoder = await new TextEncoder();
  await port.open({ baudRate: 115200 });
  const writer = await port.writable.getWriter();
  await writer.write(encoder.encode(data));
  await writer.releaseLock();
  if (port) {
    try {
      await port.close();
    } catch (e) {
    }
  }
}

</script>
